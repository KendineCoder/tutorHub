{% extends "base.html" %} {% block title %}Manage Children - Learning Hub{%
endblock %} {% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-3">
    <div class="sidebar p-3">
      <h5 class="mb-4">
        <i class="fas fa-user-friends me-2"></i>Parent Portal
      </h5>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('parent.dashboard') }}">
            <i class="fas fa-tachometer-alt me-2"></i>Overview
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="{{ url_for('parent.children') }}">
            <i class="fas fa-child me-2"></i>Children
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-9">
    <div class="main-content">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Children</h2>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addChildModal"
        >
          <i class="fas fa-plus me-1"></i>Add Child
        </button>
      </div>

      <!-- Alert for messages -->
      <div id="alertContainer"></div>

      <!-- Children List -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Children Accounts</h5>
        </div>
        <div class="card-body">
          {% if children %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for child in children %}
                <tr id="child-row-{{ child.id }}">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar bg-primary text-white me-3">
                        {{ child.username[0].upper() }}
                      </div>
                      <strong>{{ child.username }}</strong>
                    </div>
                  </td>
                  <td>{{ child.email }}</td>
                  <td>
                    {{ child.created_at.split(' ')[0] if child.created_at else
                    'N/A' }}
                  </td>
                  <td>
                    {% if child.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline-warning me-1"
                      onclick="toggleChildStatus({{ child.id }}, {{ child.is_active }})"
                    >
                      {% if child.is_active %}
                      <i class="fas fa-pause"></i> Deactivate {% else %}
                      <i class="fas fa-play"></i> Activate {% endif %}
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-user-plus text-muted fs-1 mb-3"></i>
            <h5 class="text-muted mb-3">No children added yet</h5>
            <p class="text-muted mb-4">
              Create child accounts to start tracking their learning progress
            </p>
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addChildModal"
            >
              <i class="fas fa-plus me-1"></i>Add Your First Child
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Child Modal -->
<div
  class="modal fade"
  id="addChildModal"
  tabindex="-1"
  aria-labelledby="addChildModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addChildModalLabel">Add New Child</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form id="addChildForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="childUsername" class="form-label">Username</label>
            <input
              type="text"
              class="form-control"
              id="childUsername"
              required
              placeholder="Enter child's username"
              minlength="3"
            />
            <div class="form-text">Must be at least 3 characters long</div>
          </div>
          <div class="mb-3">
            <label for="childEmail" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="childEmail"
              required
              placeholder="Enter child's email"
            />
          </div>
          <div class="mb-3">
            <label for="childPassword" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="childPassword"
              required
              placeholder="Enter password"
              minlength="6"
            />
            <div class="form-text">Must be at least 6 characters long</div>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label"
              >Confirm Password</label
            >
            <input
              type="password"
              class="form-control"
              id="confirmPassword"
              required
              placeholder="Confirm password"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <span
              class="spinner-border spinner-border-sm d-none"
              role="status"
              aria-hidden="true"
            ></span>
            Create Account
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
</style>

<script>
  document
    .getElementById("addChildForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const username = document.getElementById("childUsername").value.trim();
      const email = document.getElementById("childEmail").value.trim();
      const password = document.getElementById("childPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const spinner = submitBtn.querySelector(".spinner-border");

      // Clear previous alerts
      document.getElementById("alertContainer").innerHTML = "";

      // Validation
      if (password !== confirmPassword) {
        showAlert("Passwords do not match", "danger");
        return;
      }

      if (username.length < 3) {
        showAlert("Username must be at least 3 characters long", "danger");
        return;
      }

      if (password.length < 6) {
        showAlert("Password must be at least 6 characters long", "danger");
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      spinner.classList.remove("d-none");

      // Submit form
      fetch("/parent/api/add-child", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          username: username,
          email: email,
          password: password,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert(data.message, "success");
            document.getElementById("addChildForm").reset();
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("addChildModal")
            );
            modal.hide();
            // Reload page to show new child
            setTimeout(() => window.location.reload(), 1000);
          } else {
            showAlert(data.error || "Failed to create child account", "danger");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showAlert("An error occurred. Please try again.", "danger");
        })
        .finally(() => {
          submitBtn.disabled = false;
          spinner.classList.add("d-none");
        });
    });

  function toggleChildStatus(childId, currentStatus) {
    const action = currentStatus ? "deactivate" : "activate";

    if (!confirm(`Are you sure you want to ${action} this child account?`)) {
      return;
    }

    fetch(`/parent/api/toggle-child/${childId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showAlert(data.message, "success");
          // Reload page to show updated status
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showAlert(data.error || "Failed to update child status", "danger");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showAlert("An error occurred. Please try again.", "danger");
      });
  }

  function showAlert(message, type) {
    const alertContainer = document.getElementById("alertContainer");
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${
              type === "success"
                ? "check-circle"
                : type === "danger"
                ? "exclamation-triangle"
                : "info-circle"
            } me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    alertContainer.innerHTML = alertHtml;

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      const alert = alertContainer.querySelector(".alert");
      if (alert) {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      }
    }, 5000);
  }
</script>
{% endblock %}
