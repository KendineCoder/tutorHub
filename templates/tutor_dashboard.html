{% extends "base.html" %} {% block title %}Tutor Dashboard - Learning Hub{%
endblock %} {% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-3">
    <div class="sidebar p-3">
      <h5 class="mb-4">
        <i class="fas fa-chalkboard-teacher me-2"></i>Tutor Portal
      </h5>
      <ul class="nav nav-pills flex-column">        <li class="nav-item">
          <a class="nav-link active" href="#overview">
            <i class="fas fa-tachometer-alt me-2"></i>Overview
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('tutor.my_courses') }}">
            <i class="fas fa-book me-2"></i>My Courses
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('tutor.my_students') }}">
            <i class="fas fa-users me-2"></i>My Students
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('tutor.sessions') }}">
            <i class="fas fa-calendar me-2"></i>Sessions
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('tutor.availability') }}">
            <i class="fas fa-clock me-2"></i>Availability
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-9">
    <div class="main-content">
      <h2 class="mb-4">Tutor Dashboard</h2>

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="stats-card">
            <h4>{{ students|length }}</h4>
            <p class="mb-0">Active Students</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <h4>{{ sessions|length }}</h4>
            <p class="mb-0">Upcoming Sessions</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <h4>4.8★</h4>
            <p class="mb-0">Average Rating</p>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="row">
        <div class="col-md-6">
          <h4 class="mb-3">My Students</h4>
          {% for student in students %}
          <div class="card dashboard-card mb-3">
            <div class="card-body">
              <h6 class="card-title">
                <i class="fas fa-user me-2"></i>{{ student.username }}
              </h6>
              <p class="card-text">
                <small class="text-muted">{{ student.email }}</small>
              </p>
              <button
                class="btn btn-sm btn-outline-primary"
                onclick="viewStudentProgress({{ student.id }})"
              >
                <i class="fas fa-chart-line me-1"></i>View Progress
              </button>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="col-md-6">
          <h4 class="mb-3">Upcoming Sessions</h4>
          {% for session in sessions %}
          <div class="card dashboard-card session-card mb-3">
            <div class="card-body">
              <h6 class="card-title">
                <i class="fas fa-user-graduate me-2"></i>{{ session.student_name
                }}
              </h6>
              <p class="card-text">
                <small class="text-muted">
                  <i class="fas fa-calendar me-1"></i>{{ session.scheduled_date
                  }}<br />
                  <i class="fas fa-clock me-1"></i>{{ session.scheduled_time }}
                </small>
              </p>
              <span
                class="badge bg-{{ 'success' if session.status == 'scheduled' else 'warning' }}"
              >
                {{ session.status.title() }}
              </span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Student Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title text-white">
          <i class="fas fa-chart-line me-2"></i>Student Progress
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="progressContent">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading student progress...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // View student progress
  function viewStudentProgress(studentId) {
    const modal = new bootstrap.Modal(document.getElementById("progressModal"));
    modal.show();

    // Reset content to loading
    document.getElementById("progressContent").innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading student progress...</p>
        </div>
    `;

    // Fetch student progress data
    fetch(`/tutor/api/student-progress/${studentId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          document.getElementById("progressContent").innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.error}
                    </div>
                `;
          return;
        }

        let progressHTML = `
                <div class="mb-4">
                    <h6><i class="fas fa-user me-2"></i>Student: ${data.student.username}</h6>
                    <p class="text-muted mb-3">${data.student.email}</p>
                </div>
            `;

        if (data.courses.length === 0) {
          progressHTML += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No course progress found for courses you've taught this student.
                    </div>
                `;
        } else {
          progressHTML += `<h6 class="mb-3"><i class="fas fa-book me-2"></i>Course Progress (Courses You've Taught):</h6>`;

          data.courses.forEach((course) => {
            const progressColor =
              course.progress >= 80
                ? "success"
                : course.progress >= 50
                ? "warning"
                : "danger";
            const statusBadge =
              course.status === "completed" ? "bg-success" : "bg-primary";

            progressHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${
                                      course.title
                                    }</h6>
                                    <span class="badge ${statusBadge}">${
              course.status.charAt(0).toUpperCase() + course.status.slice(1)
            }</span>
                                    <span class="badge bg-secondary ms-2">${
                                      course.sessions_with_tutor
                                    } sessions</span>
                                </div>
                                <p class="card-text text-muted mb-3">${
                                  course.description
                                }</p>
                                
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <div class="progress mb-2" style="height: 10px;">
                                            <div class="progress-bar bg-${progressColor}" role="progressbar"
                                                 style="width: ${
                                                   course.progress
                                                 }%"
                                                 aria-valuenow="${
                                                   course.progress
                                                 }"
                                                 aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            ${course.completed_lessons} of ${
              course.total_lessons
            } lessons completed (${course.progress}%)
                                        </small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>Enrolled: ${
                                              course.enrolled_date
                                            }
                                            ${
                                              course.last_activity
                                                ? `<br><i class="fas fa-clock me-1"></i>Last activity: ${new Date(
                                                    course.last_activity
                                                  ).toLocaleDateString()}`
                                                : ""
                                            }
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
          });
        }

        // Add sessions history
        if (data.sessions_history.length > 0) {
          progressHTML += `
                    <h6 class="mb-3 mt-4"><i class="fas fa-history me-2"></i>Recent Sessions:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Course</th>
                                    <th>Status</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

          data.sessions_history.slice(0, 5).forEach((session) => {
            const statusColor =
              session.status === "completed"
                ? "success"
                : session.status === "cancelled"
                ? "danger"
                : "warning";
            const rating = session.rating
              ? "★".repeat(session.rating) + "☆".repeat(5 - session.rating)
              : "Not rated";

            progressHTML += `
                        <tr>
                            <td>${session.scheduled_date} ${
              session.scheduled_time
            }</td>
                            <td>${
                              session.course_title || "General Tutoring"
                            }</td>
                            <td><span class="badge bg-${statusColor}">${
              session.status
            }</span></td>
                            <td>${rating}</td>
                        </tr>
                    `;
          });

          progressHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
        }

        document.getElementById("progressContent").innerHTML = progressHTML;
      })
      .catch((error) => {
        console.error("Error:", error);
        document.getElementById("progressContent").innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading student progress. Please try again.
                </div>
            `;
      });
  }
</script>
{% endblock %}
